# ================================================================================================
#  workshop
#  Copyright (C) 2022 Tim Leonard
# ================================================================================================
type: shader
version: 1

# This effect is used to calculate light probe diffuse + visibility via raytracing.

imports: [ data:shaders/common.yaml ]

effects:
  ddgi_trace:
    techniques:
      ddgi_trace: {}
  ddgi_output_irradiance:
    techniques:
      ddgi_output_irradiance: {}
  ddgi_output_occlusion:
    techniques:
      ddgi_output_occlusion: {}   
  ddgi_relocate:
    techniques:
      ddgi_relocate: {}   
  ddgi_classify:
    techniques:
      ddgi_classify: {}   

param_blocks:
  ddgi_probe_parameters:
    scope: draw
    fields:
      scene_tlas: tlas
      scene_tlas_metadata: byteaddressbuffer
      probe_far_z: float
      probe_ray_count: int
      scratch_buffer: rwbyteaddressbuffer
      probe_data_buffer: byteaddressbuffer
      probe_distance_exponent: float
      probe_blend_hysteresis: float
      probe_large_change_threshold: float
      probe_brightness_threshold: float
      probe_fixed_ray_backface_threshold: float 
      probe_min_frontface_distance: float       
      random_ray_rotation: float4

  # One instance of this param block is stored for every
  # ray into the scrach_buffer. This is combined into the 
  # final output by the sh generation step.
  ddgi_probe_scrach_data:
    scope: indirect
    fields:  
      color: float3
      normal: float3
      distance: float
      valid: bool
      back_face: bool

  ddgi_probe_data:
    scope: indirect
    fields:  
      probe_index: int
      probe_origin: float3
      irradiance_texture: rwtexture2d
      irradiance_map_size: int
      irradiance_per_row: int
      occlusion_texture: rwtexture2d
      occlusion_map_size: int
      occlusion_per_row: int
      probe_spacing: float
      probe_state_buffer: rwbyteaddressbuffer

techniques:
  ddgi_trace:
    ray_generation_shader: 
      file: data:shaders/source/ddgi/ddgi_trace.hlsl
      entry: ray_generation
    ray_hitgroups: [ 
      primitive_opaque_hitgroup, 
      primitive_masked_hitgroup, 
      primitive_transparent_hitgroup, 
      primitive_sky_hitgroup,
      occlusion_opaque_hitgroup, 
      occlusion_masked_hitgroup, 
      occlusion_transparent_hitgroup, 
      occlusion_sky_hitgroup 
    ]
    ray_missgroups: [ 
      primitive_missgroup, 
      occlusion_missgroup 
    ]
    render_state: raytrace_scene_render_state
    param_blocks: [ 
      ddgi_probe_parameters, 
      ddgi_probe_scrach_data,
      ddgi_probe_data,
      tlas_metadata,
      view_info, 
      gbuffer,
      light_state, 
      light_cluster, 
      light_probe_grid_state, 
      light_probe_state,
      reflection_probe_state,
      shadow_map_state, 
      resolve_lighting_parameters 
    ]
    defines:    
      #DISABLE_AMBIENT_LIGHTING: 1   # Don't want to read probe data while raytracing scene as its incomplete. 
      DO_NOT_USE_LIGHT_CLUSTERS: 1  # As we can trace in all directions using the light clusters isn't helpful for us, so just iterate the full list, bleh. 
      DISABLE_VISUALIZATION_MODES: 1 # Ignore any visualization modes when calculating shading.

  ddgi_output_irradiance:
    compute_shader: 
      file: data:shaders/source/ddgi/ddgi_output.hlsl
      entry: output_irradiance_cshader
    param_blocks: [ 
      ddgi_probe_parameters, 
      ddgi_probe_scrach_data,
      ddgi_probe_data,
      tlas_metadata,
      view_info, 
      gbuffer,
      light_state, 
      light_cluster, 
      light_probe_grid_state, 
      light_probe_state,
      reflection_probe_state,
      shadow_map_state, 
      resolve_lighting_parameters 
    ]

  ddgi_output_occlusion:
    compute_shader: 
      file: data:shaders/source/ddgi/ddgi_output.hlsl
      entry: output_occlusion_cshader
    param_blocks: [ 
      ddgi_probe_parameters, 
      ddgi_probe_scrach_data,
      ddgi_probe_data,
      tlas_metadata,
      view_info, 
      gbuffer,
      light_state, 
      light_cluster, 
      light_probe_grid_state, 
      light_probe_state,
      reflection_probe_state,
      shadow_map_state, 
      resolve_lighting_parameters 
    ]
      
  ddgi_relocate:
    compute_shader: 
      file: data:shaders/source/ddgi/ddgi_relocate.hlsl
      entry: relocate_cshader
    param_blocks: [ 
      ddgi_probe_parameters, 
      ddgi_probe_scrach_data,
      ddgi_probe_data,
      tlas_metadata,
      view_info, 
      gbuffer,
      light_state, 
      light_cluster, 
      light_probe_grid_state, 
      light_probe_state,
      reflection_probe_state,
      shadow_map_state, 
      resolve_lighting_parameters 
    ]

  ddgi_classify:
    compute_shader: 
      file: data:shaders/source/ddgi/ddgi_classify.hlsl
      entry: classify_cshader
    param_blocks: [ 
      ddgi_probe_parameters, 
      ddgi_probe_scrach_data,
      ddgi_probe_data,
      tlas_metadata,
      view_info, 
      gbuffer,
      light_state, 
      light_cluster, 
      light_probe_grid_state, 
      light_probe_state,
      reflection_probe_state,
      shadow_map_state, 
      resolve_lighting_parameters 
    ]