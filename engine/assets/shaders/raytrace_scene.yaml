# ================================================================================================
#  workshop
#  Copyright (C) 2022 Tim Leonard
# ================================================================================================
type: shader
version: 1

# This effect does a simple raytrace of the scene and emits the results to
# a render target. This is mostly here for debugging the raytracing pipeline.

imports: [ data:shaders/common.yaml ]

effects:
  raytrace_scene:
    techniques:
      raytrace_scene: {}
   
param_blocks:
  raytrace_scene_parameters:
    scope: draw
    fields:
      scene_tlas: tlas
      scene_tlas_metadata: byteaddressbuffer
      output_texture: rwtexture2d

techniques:
  raytrace_scene:
    ray_generation_shader: 
      file: data:shaders/source/raytrace_scene.hlsl
      entry: ray_generation
    ray_hitgroups: [ 
      primitive_opaque_hitgroup, 
      primitive_masked_hitgroup, 
      primitive_transparent_hitgroup, 
      primitive_sky_hitgroup,
      occlusion_opaque_hitgroup, 
      occlusion_masked_hitgroup, 
      occlusion_transparent_hitgroup, 
      occlusion_sky_hitgroup 
    ]
    ray_missgroups: [ 
      primitive_missgroup, 
      occlusion_missgroup 
    ]
    render_state: raytrace_scene_render_state
    param_blocks: [ 
      raytrace_scene_parameters, 
      tlas_metadata,
      view_info, 
      gbuffer,
      light_state, 
      light_cluster, 
      light_probe_grid_state, 
      reflection_probe_state,
      shadow_map_state, 
      resolve_lighting_parameters 
    ]
    defines:    
      DO_NOT_USE_LIGHT_CLUSTERS: 1   # As we can trace in all directions using the light clusters isn't helpful for us, so just iterate the full list, bleh. 
      DISABLE_VISUALIZATION_MODES: 1 # Ignore any visualization modes when calculating shading.