# ================================================================================================
#  workshop
#  Copyright (C) 2022 Tim Leonard
# ================================================================================================
type: shader
version: 1

# This effect does a simple raytrace of the scene and emits the results to
# a render target. This is mostly here for debugging the raytracing pipeline.

imports: [ data:shaders/common.yaml ]

effects:
  raytrace_scene:
    techniques:
      raytrace_scene: {}
   
param_blocks:
  raytrace_scene_parameters:
    scope: draw
    fields:
      scene_tlas: tlas
      scene_tlas_metadata: byteaddressbuffer

ray_hitgroups:
  # Primitive ray types
  opaque_hitgroup:
    material_domain: opaque
    ray_type: primitive
    ray_closest_hit_shader: 
      file: data:shaders/source/raytrace_scene.hlsl
      entry: ray_primitive_opaque_closest_hit
  masked_hitgroup:
    material_domain: masked
    ray_type: primitive
    ray_closest_hit_shader: 
      file: data:shaders/source/raytrace_scene.hlsl
      entry: ray_primitive_masked_closest_hit    
    ray_any_hit_shader: 
      file: data:shaders/source/raytrace_scene.hlsl
      entry: ray_primitive_masked_any_hit
  transparent_hitgroup:
    material_domain: transparent
    ray_type: primitive
    ray_any_hit_shader: 
      file: data:shaders/source/raytrace_scene.hlsl
      entry: ray_primitive_transparent_any_hit      
  sky_hitgroup:
    material_domain: sky
    ray_type: primitive
    ray_closest_hit_shader: 
      file: data:shaders/source/raytrace_scene.hlsl
      entry: ray_primitive_sky_closest_hit
  # Occlusion ray types
  # TODO

ray_missgroups:
  # Primitive ray types
  primitive_missgroup:
    ray_type: primitive
    ray_miss_shader:
      file: data:shaders/source/raytrace_scene.hlsl
      entry: ray_primitive_miss
  # Occlusion ray types
  # TODO

render_states:
  raytrace_scene_render_state:
    max_rt_payload_size: 32

techniques:
  raytrace_scene:
    ray_generation_shader: 
      file: data:shaders/source/raytrace_scene.hlsl
      entry: ray_generation
    ray_hitgroups: [ opaque_hitgroup, masked_hitgroup, transparent_hitgroup, sky_hitgroup ]
    ray_missgroups: [ primitive_missgroup ]
    render_state: raytrace_scene_render_state
    param_blocks: [ raytrace_scene_parameters, tlas_metadata ]