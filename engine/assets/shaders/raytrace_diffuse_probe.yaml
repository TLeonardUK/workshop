# ================================================================================================
#  workshop
#  Copyright (C) 2022 Tim Leonard
# ================================================================================================
type: shader
version: 1

# This effect is used to calculate light probe diffuse + visibility via raytracing.

imports: [ data:shaders/common.yaml ]

effects:
  raytrace_diffuse_probe:
    techniques:
      raytrace_diffuse_probe: {}
  raytrace_diffuse_probe_output_irradiance:
    techniques:
      raytrace_diffuse_probe_output_irradiance: {}
  raytrace_diffuse_probe_output_occlusion:
    techniques:
      raytrace_diffuse_probe_output_occlusion: {}   

param_blocks:
  raytrace_diffuse_probe_parameters:
    scope: draw
    fields:
      scene_tlas: tlas
      scene_tlas_metadata: byteaddressbuffer
      probe_far_z: float
      probe_ray_count: int
      scratch_buffer: rwbyteaddressbuffer
      probe_data_buffer: byteaddressbuffer
      probe_distance_exponent: float

  # One instance of this param block is stored for every
  # ray into the scrach_buffer. This is combined into the 
  # final output by the sh generation step.
  raytrace_diffuse_probe_scrach_data:
    scope: indirect
    fields:  
      color: float3
      normal: float3
      distance: float
      valid: bool
      back_face: bool

  # Describes a probe to be traced.
  raytrace_diffuse_probe_data:
    scope: indirect
    fields:  
      probe_index: int
      probe_origin: float3
      irradiance_texture: rwtexture2d
      irradiance_map_size: int
      irradiance_per_row: int
      occlusion_texture: rwtexture2d
      occlusion_map_size: int
      occlusion_per_row: int
      probe_spacing: float

techniques:
  raytrace_diffuse_probe:
    ray_generation_shader: 
      file: data:shaders/source/ddgi/raytrace_diffuse_probe.hlsl
      entry: ray_generation
    ray_hitgroups: [ 
      primitive_opaque_hitgroup, 
      primitive_masked_hitgroup, 
      primitive_transparent_hitgroup, 
      primitive_sky_hitgroup,
      occlusion_opaque_hitgroup, 
      occlusion_masked_hitgroup, 
      occlusion_transparent_hitgroup, 
      occlusion_sky_hitgroup 
    ]
    ray_missgroups: [ 
      primitive_missgroup, 
      occlusion_missgroup 
    ]
    render_state: raytrace_scene_render_state
    param_blocks: [ 
      raytrace_diffuse_probe_parameters, 
      raytrace_diffuse_probe_scrach_data,
      raytrace_diffuse_probe_data,
      tlas_metadata,
      view_info, 
      gbuffer,
      light_state, 
      light_cluster, 
      light_probe_grid_state, 
      reflection_probe_state,
      shadow_map_state, 
      resolve_lighting_parameters 
    ]
    defines:    
      DISABLE_AMBIENT_LIGHTING: 1   # Don't want to read probe data while raytracing scene as its incomplete. 
      DO_NOT_USE_LIGHT_CLUSTERS: 1  # As we can trace in all directions using the light clusters isn't helpful for us, so just iterate the full list, bleh. 
      DISABLE_VISUALIZATION_MODES: 1 # Ignore any visualization modes when calculating shading.

  raytrace_diffuse_probe_output_irradiance:
    compute_shader: 
      file: data:shaders/source/ddgi/raytrace_diffuse_probe.hlsl
      entry: output_irradiance_cshader
    param_blocks: [ 
      raytrace_diffuse_probe_parameters, 
      raytrace_diffuse_probe_scrach_data,
      raytrace_diffuse_probe_data,
      tlas_metadata,
      view_info, 
      gbuffer,
      light_state, 
      light_cluster, 
      light_probe_grid_state, 
      reflection_probe_state,
      shadow_map_state, 
      resolve_lighting_parameters 
    ]
    defines:
      DISPATCH_SIZE_X: 1 # If changed, ensure you change 
      DISPATCH_SIZE_Y: 1
      DISPATCH_SIZE_Z: 1

  raytrace_diffuse_probe_output_occlusion:
    compute_shader: 
      file: data:shaders/source/ddgi/raytrace_diffuse_probe.hlsl
      entry: output_occlusion_cshader
    param_blocks: [ 
      raytrace_diffuse_probe_parameters, 
      raytrace_diffuse_probe_scrach_data,
      raytrace_diffuse_probe_data,
      tlas_metadata,
      view_info, 
      gbuffer,
      light_state, 
      light_cluster, 
      light_probe_grid_state, 
      reflection_probe_state,
      shadow_map_state, 
      resolve_lighting_parameters 
    ]
    defines:
      DISPATCH_SIZE_X: 1 # If changed, ensure you change 
      DISPATCH_SIZE_Y: 1
      DISPATCH_SIZE_Z: 1